tinymce.PluginManager.add('imagelocal', function (editor) {

    function downloadImage(url) {

    }
    function change() {
        tinymce.activeEditor.windowManager.confirm("确定要将外链图片下载到您的服务器吗？这可能会花一些时间。", function (s) {
            if (s) {
                tinyMCE.activeEditor.setProgressState(true);
                var content = editor.getContent();
                var imageUrls = [];
                $("img", "<div>" + editor.getContent() + "</div>").each(function () {
                    var url = $(this).attr("src");
                    if (imageUrls.indexOf(url) < 0 && url.indexOf("/") != 0 && "".replace("http://", "").replace("https://", "").indexOf(window.location.hostname) != 0) {
                        imageUrls.push(url);
                    }
                });
                if (imageUrls.length > 0) {

                    $.post("/admin/Media/DownLoadExternalImage", { images: imageUrls }, function (data) {
                        if (data) {
                            for (var i = 0; i < data.length; i++) {
                                content = content.replace(data[i].key, data[i].value);
                            }
                            editor.setContent(content);
                            tinyMCE.activeEditor.setProgressState(false);
                        }
                    }, "json");
                } else {
                    tinyMCE.activeEditor.setProgressState(false);
                }
            }
        });

    }

    editor.addMenuItem('insertimagelocal', {
        icon: '',
        text: '下载外链图',
        context: 'edit',
        onclick: change,
        prependToContext: false
    });
});